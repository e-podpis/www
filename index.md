h1. PGP

h2. Порядок работы с ЭЦП

*Последовательность действий (только один раз после установки Клеопатры):*

1) Открываешь Клеопатру (скачать можно с сайта https://www.gpg4win.org/  или @sudo apt-get install kleopatra@)
2) Нажимаешь Lookup on Server
3) Вводишь email партнёра
4) Находишь там запись партнёра, импортируешь его сертификат себе в реестр сертификатов.
5) Тебе предлагают его сертифицировать.
6) Соглашаешься.
7) Тебя попросят сличить fingerprint, сравниваешь его с тем, который тебе в платеже 10 руб пришел. Если совпадает, значит сертифицируешь.


*Последовательность действий после получения подписи от партнёра:*
1) запустить Клеопатру
2) нажать Decrypt/Verify
3) выбрать файл договора
4) нажать Next или типа того, он тебе ругнется, что подписи нет, предложит ее выбрать
5) выбратьт файл подписи
6) далее выскочит зеленая плашка, что подпись верна.

h2. QA

*Как подписать документ*

Просто открыть Kleopatr'у и нажать Sign/Encrypt, далее снять галочки Encrypt, чтоб была только подпись. Далее sig файл можно послать мне. Можно подписать все файлы пачкой.

*Что подписать*

Всё, что захочется. Но подписывать изменяемые файлы бессмысленно, так как подпись сразу же станет невалидной. Надо подписывать статические неизменяемые файлы.

Примеры
 - dogovor.docx - изменяемый, его подписывать не надо
 - dogovor.pdf - статический, неизменяемый. его можно подписать

*Как проверить, что договор\акт никто не менял*

У вас есть приватный ключ, который вы храните в секрете от всех. Надо сделать его копию.
У вас есть публичный ключ, который вместе с информацией о вас (фио, email) называется сертификатом и может лежать где-то в интернете (например на вашем сайте на видном месте).
Любой, кто имеет ваш сертификат, может импортировать его себе в клеопатру и проверить подпись: для этого ему нужен оригинал документа и саму подпись. Проверка делается кнопкой "Проверить\Verify".

*Как сертификат передать?*

В мире много серверов (в основном это сервера крупных университетов и прочие open source коммьюнити), которые позволяют размещать сертификаты. Поэтому мой сертификат вы можете скачать с серверов, нажав кнопку Lookup Key
Можете и ваш туда загрузить, и я его скачаю. Можете по почте его выслать.

*Что если злоумышленник выпустит свою подпись под вашим именем?*

Для этого нужно ваш сертификат удостоверить. Платные сервисы (типа Контур диадока) берут за это деньги. У нас же все бесплатно, поэтому нам нужно самим удостовериться, что тот сертификат, который вы скачали с сервера, или каким-то другим способом получили от меня был выпущен именно мной. Собственно этим и отличаются квалифицированная от неквалифицированной подписи: квалифицированная - значит есть 3-е лицо, которому мы оба доверяем, кто может удостоверить. Неквалифицированная в нашем случае должна быть заверена собственноручно. Для простоты от публичного ключа делют легко читаемый человеком хэш (называется отпечаток), и этот хэш можно распечатать на бумаге и собственноручно подписать. Вместо этого я просто направляю вам платеж на 10 руб. в котором указываю _Отпечаток публ. ключа OpenPGP 4D9A CE4F 2ED3 8F81 3A30 B340 F004 AF4F 43A1 F729. Данная ЭЦП является аналогом собственноручной подписи {Моё полное ФИО}. Без НДС_
Т.к. моя платежка подписана ЭЦП, которую мне выдал банк, а эта банковская ЭЦП заверена мной собственноручно при заполнении бланка банка (поэтому нужна встреча с представителем банка), то цепочка сходится.

*Что в итоге делать то?*
1.	Верните мне мои 10 руб. (и не забудьте пометить их как возврат средств в бухгалтерии, чтобы не платить с них налог) и указав свой Отпечаток в ответ.
2.	Зайдите в дропбокс и загрузите туда подписи.
Вроде все просто. Никаких бумаг. 

*Что если налоговая\банк попросят документы на бумаге*

Здесь юридическая неопределенность. С одной стороны мы защищены законом и можем 100% доказать подписание документов технически. С другой стороны, банк не факт что готов ставить себе open source софт для проверки.  Поэтому по закону мы всегда сможем предоставить подписи в срок (формально), а при необходимости можем переслать необходимые документы по старинке для простоты. Хотя вцелом распечатка сертификата и платжки с Отпечатком обычно является достаточным средством в подавляющем большинстве случаев.

*Есть какие-то устоявшиеся процессы?*

# подписывать docx не стоит, лучше pdf, так как подписывается хэш сумма файла, а MS Word у docx постоянно хеш меняет при переоткрытии, и подпись становится недействительной;
# pgp так устроен, что допустим если документ называется agreement.pdf, то подпись к нему будет {filename}.sig, в нашем случае agreement.pdf.sig. А так как договор в одном экземпляре, а подписей две - по одной от каждой стороны, то непонятно как это хранить в одной папке. делается это либо добавлением суффикса инициалов подписанта, например agreement.pdf.kk.sig, agreement.pdf.vb.sig, но в этом случае инструменты pgp не могут найти подпись (по умолчанию ищут по шаблону {filename}.sig) и приходится им явно указывать. что есть небольшое неудобство, но это неудобство касается только того, как человек локально на компе файлы хранит. 
# так как пачка документов, которые мы должны предоставить официалам должна позволить им провалидировать подпись, сделать это невозможно без сертификатов, а также доказательства того, что сертификат бы сертифицирован, то крайне желательным к договору прикрепить сертификаты подписантов (публичные ключи), а также платежки из банков с 10 руб и правильным назначением платежа.
